on:
  push:
    branches:
      - master

jobs:
  amplify-deploy:
    name: ðŸš€ AWS Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Start Deployment
        # This step creates a new deployment, check them out here:
        # https://github.com/Khenziii/khenzii-dev/deployments

        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          step: start
          token: ${{ secrets.TOKEN_GITHUB }}
          env: Production

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Install Amplify CLI
        run: npm install -g @aws-amplify/cli

      - name: Push To Amplify
        run: |
          amplify push

      - name: Update Deployment Status
        uses: bobheadxi/deployments@v1
        if: always()
        with:
          step: finish
          token: ${{ secrets.TOKEN_GITHUB }}
          status: ${{ job.status }}
          env: ${{ steps.deployment.outputs.env }}
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
